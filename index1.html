<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å°†æˆ¦ç•¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ - Webãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</title>
    <style>
        :root {
            --bg-color: #202020;
            --text-color: #e0e0e0;
            --accent-color: #d4af37; /* å¤§å°†ã£ã½ã„é‡‘è‰² */
            --grid-size: 30px;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }

        h1 { margin-bottom: 10px; border-bottom: 2px solid var(--accent-color); }
        
        /* UIãƒ‘ãƒãƒ« */
        .ui-panel {
            width: 100%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            background: #333;
            padding: 10px;
            border-radius: 5px;
        }

        .btn {
            background: #444;
            color: white;
            border: 1px solid #666;
            padding: 5px 15px;
            cursor: pointer;
            border-radius: 4px;
        }
        .btn:hover { background: #555; }
        .btn-action { background: var(--accent-color); color: #000; font-weight: bold; }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆãƒãƒƒãƒ—ï¼‰ */
        #game-board {
            display: grid;
            grid-template-columns: repeat(15, var(--grid-size));
            grid-template-rows: repeat(15, var(--grid-size));
            gap: 1px;
            background-color: #111;
            border: 2px solid #555;
            margin-bottom: 10px;
        }

        .cell {
            width: var(--grid-size);
            height: var(--grid-size);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: default;
        }

        /* ã‚¿ã‚¤ãƒ«å®šç¾© */
        .floor { background-color: #2e3b28; color: #444; } /* å¹³åœ° */
        .wall { background-color: #5d4037; color: #3e2723; } /* å£ */
        .player { color: #fff; text-shadow: 0 0 5px yellow; z-index: 10; }
        .enemy { color: #ff5555; z-index: 5; }

        /* ãƒ­ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
        #log-window {
            width: 100%;
            max-width: 500px;
            height: 150px;
            background: #000;
            border: 1px solid #444;
            overflow-y: scroll;
            font-family: monospace;
            padding: 5px;
            font-size: 14px;
        }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #222; }
        .log-new { color: #88ff88; }
        .log-warn { color: #ff8888; }

        /* ã‚¹ãƒãƒ›ç”¨æ“ä½œãƒ‘ãƒƒãƒ‰ */
        .controls {
            display: grid;
            grid-template-columns: repeat(3, 50px);
            gap: 5px;
            margin-top: 10px;
        }
        .control-btn {
            width: 50px;
            height: 50px;
            background: #444;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
        }
    </style>
</head>
<body>

    <h1>å¤§å°†æˆ¦ç•¥ãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯</h1>

    <!-- ä¸Šéƒ¨HUD -->
    <div class="ui-panel">
        <div>
            <div>HP: <span id="hp-display">100/100</span></div>
            <div>Seed: <span id="seed-display">----</span></div>
        </div>
        <div>
            <button class="btn" onclick="game.saveGame()">ã‚»ãƒ¼ãƒ–</button>
            <button class="btn" onclick="game.loadGame()">ãƒ­ãƒ¼ãƒ‰</button>
            <button class="btn" onclick="game.initGame()">New Game</button>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ç›¤é¢ -->
    <div id="game-board"></div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="ui-panel" style="justify-content: center;">
        <button class="btn btn-action" onclick="game.issueCommand()">æˆ¦ç•¥ã‚³ãƒãƒ³ãƒ‰ï¼šå…¨è»çªæ’ƒ</button>
    </div>

    <!-- ãƒ­ã‚° -->
    <div id="log-window"></div>

    <!-- æ“ä½œãƒ‘ãƒƒãƒ‰ (PCãªã‚‰ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰WASDã§æ“ä½œå¯èƒ½) -->
    <div class="controls">
        <div></div>
        <button class="control-btn" onclick="game.movePlayer(0, -1)">â–²</button>
        <div></div>
        <button class="control-btn" onclick="game.movePlayer(-1, 0)">â—€</button>
        <button class="control-btn" onclick="game.movePlayer(0, 1)">â–¼</button>
        <button class="control-btn" onclick="game.movePlayer(1, 0)">â–¶</button>
    </div>

    <p><small>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ: W,A,S,D ã¾ãŸã¯ çŸ¢å°ã‚­ãƒ¼</small></p>

<script>
/**
 * ============================================
 * ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ (JavaScriptç‰ˆ)
 * C#ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’JSã®ã‚¯ãƒ©ã‚¹æ§‹é€ ã«ç§»æ¤ã—ã¦ã„ã¾ã™
 * ============================================
 */

// ä¹±æ•°ç”Ÿæˆå™¨ (ã‚·ãƒ¼ãƒ‰å€¤ä»˜ã)
// Math.random()ã¯ã‚·ãƒ¼ãƒ‰æŒ‡å®šã§ããªã„ãŸã‚ã€ç°¡æ˜“çš„ãªLCGã‚’ä½¿ç”¨
class Random {
    constructor(seed) {
        this.seed = seed;
    }
    // 0 ~ 1 ã®ä¹±æ•°ã‚’è¿”ã™
    next() {
        var t = this.seed += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
    // minä»¥ä¸Šmaxæœªæº€ã®æ•´æ•°
    range(min, max) {
        return Math.floor(this.next() * (max - min) + min);
    }
}

// ãƒ‡ãƒ¼ã‚¿å®šæ•°
const TILE_FLOOR = 0;
const TILE_WALL = 1;
const BOARD_W = 15;
const BOARD_H = 15;

// ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ã‚¯ãƒ©ã‚¹
class GameEngine {
    constructor() {
        this.data = {
            seed: 0,
            mapData: [],
            player: { x: 1, y: 1, hp: 100, maxHp: 100 },
            enemies: []
        };
        this.boardEl = document.getElementById('game-board');
        this.logEl = document.getElementById('log-window');
        this.hpEl = document.getElementById('hp-display');
        this.seedEl = document.getElementById('seed-display');
    }

    // åˆæœŸåŒ–ã¨ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ 
    initGame() {
        const seed = Math.floor(Math.random() * 10000);
        this.data.seed = seed;
        this.data.player = { x: 1, y: 1, hp: 100, maxHp: 100 };
        this.data.enemies = [];
        
        this.log("ã‚·ã‚¹ãƒ†ãƒ ", "æ–°ã—ã„ãƒãƒƒãƒ—ã‚’ç”Ÿæˆä¸­... Seed:" + seed);
        this.generateMap(seed);
        
        // æ•µã®ç”Ÿæˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ é…ç½®ï¼‰
        const rng = new Random(seed + 1); // æ•µé…ç½®ç”¨ã‚·ãƒ¼ãƒ‰
        for(let i=0; i<5; i++) {
            let ex = rng.range(1, BOARD_W - 1);
            let ey = rng.range(1, BOARD_H - 1);
            if(this.data.mapData[ey * BOARD_W + ex] === TILE_FLOOR && !(ex===1 && ey===1)) {
                this.data.enemies.push({ x: ex, y: ey, hp: 30, id: i });
            }
        }

        this.render();
        this.updateHUD();
    }

    // ãƒãƒƒãƒ—ç”Ÿæˆ (C#ã®GenerateMapã«å¯¾å¿œ)
    generateMap(seed) {
        const rng = new Random(seed);
        this.data.mapData = [];
        for (let y = 0; y < BOARD_H; y++) {
            for (let x = 0; x < BOARD_W; x++) {
                // å¤–å‘¨ã¯å£
                if (x === 0 || x === BOARD_W - 1 || y === 0 || y === BOARD_H - 1) {
                    this.data.mapData.push(TILE_WALL);
                } else {
                    // 20%ã®ç¢ºç‡ã§å£
                    this.data.mapData.push(rng.next() < 0.2 ? TILE_WALL : TILE_FLOOR);
                }
            }
        }
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ã¯å¿…ãšå¹³åœ°ã«
        this.data.mapData[1 * BOARD_W + 1] = TILE_FLOOR;
    }

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•å‡¦ç†
    movePlayer(dx, dy) {
        if (this.data.player.hp <= 0) {
            this.log("è­¦å‘Š", "å¤§å°†ã¯å€’ã‚Œã¦ã„ã¾ã™... New Gameã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        const newX = this.data.player.x + dx;
        const newY = this.data.player.y + dy;
        const index = newY * BOARD_W + newX;

        // å£åˆ¤å®š
        if (this.data.mapData[index] === TILE_WALL) {
            this.log("ç§»å‹•", "ãã“ã¯å£ã§é€²ã‚ã¾ã›ã‚“ï¼");
            return;
        }

        // æ•µè¡çªåˆ¤å®šï¼ˆæ”»æ’ƒï¼‰
        const enemyIndex = this.data.enemies.findIndex(e => e.x === newX && e.y === newY);
        if (enemyIndex !== -1) {
            this.attackEnemy(enemyIndex);
            this.enemyTurn(); // æ”»æ’ƒã—ãŸã‚‰æ•µã‚‚å‹•ã
            this.render();
            return;
        }

        // ç§»å‹•å®Ÿè¡Œ
        this.data.player.x = newX;
        this.data.player.y = newY;
        
        this.enemyTurn();
        this.render();
        this.updateHUD();
    }

    // æ”»æ’ƒå‡¦ç†
    attackEnemy(index) {
        const enemy = this.data.enemies[index];
        const dmg = 10; // å›ºå®šãƒ€ãƒ¡ãƒ¼ã‚¸
        enemy.hp -= dmg;
        this.log("æˆ¦é—˜", `æ•µéƒ¨éšŠã« ${dmg} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã¾ã—ãŸï¼`);
        
        if (enemy.hp <= 0) {
            this.log("æˆ¦é—˜", "æ•µéƒ¨éšŠã‚’æ’ƒç ´ã—ã¾ã—ãŸï¼");
            this.data.enemies.splice(index, 1);
        }
    }

    // æ•µAIã‚¿ãƒ¼ãƒ³
    enemyTurn() {
        this.data.enemies.forEach(enemy => {
            // ç°¡æ˜“AI: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å‘ã‹ã£ã¦ãã‚‹
            let dx = 0, dy = 0;
            if (Math.random() < 0.5) { // 50%ã§Xè»¸ç§»å‹•ã€50%ã§Yè»¸ç§»å‹•
                if (enemy.x < this.data.player.x) dx = 1;
                else if (enemy.x > this.data.player.x) dx = -1;
            } else {
                if (enemy.y < this.data.player.y) dy = 1;
                else if (enemy.y > this.data.player.y) dy = -1;
            }

            // ç§»å‹•å…ˆãƒã‚§ãƒƒã‚¯
            const nextX = enemy.x + dx;
            const nextY = enemy.y + dy;
            const index = nextY * BOARD_W + nextX;

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æ”»æ’ƒ
            if (nextX === this.data.player.x && nextY === this.data.player.y) {
                const dmg = 5;
                this.data.player.hp -= dmg;
                this.log("è­¦å‘Š", `æ•µã®æ”»æ’ƒï¼å¤§å°†ãŒ ${dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã¾ã—ãŸï¼`, true);
                return;
            }

            // å£ã§ãªã‘ã‚Œã°ç§»å‹• (ä»–ã®æ•µã¨ã®è¡çªã¯ç°¡æ˜“çš„ã«ç„¡è¦–)
            if (this.data.mapData[index] !== TILE_WALL) {
                enemy.x = nextX;
                enemy.y = nextY;
            }
        });
        
        if (this.data.player.hp <= 0) {
            this.data.player.hp = 0;
            this.log("æ•—åŒ—", "å¤§å°†ãŒè¨ã¡å–ã‚‰ã‚Œã¾ã—ãŸ... ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼", true);
        }
    }

    // æˆ¦ç•¥ã‚³ãƒãƒ³ãƒ‰
    issueCommand() {
        if(this.data.player.hp <= 0) return;
        
        // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¨ã—ã¦ã€å‘¨å›²ã®æ•µã‚’å¹ãé£›ã°ã™ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
        this.log("å·ä»¤", "å…¨è»çªæ’ƒï¼å‘¨å›²ã®æ•µã«ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼");
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‘¨å›²3ãƒã‚¹ä»¥å†…ã®æ•µã«ãƒ€ãƒ¡ãƒ¼ã‚¸
        let hitCount = 0;
        for(let i = this.data.enemies.length - 1; i >= 0; i--) {
            const e = this.data.enemies[i];
            const dist = Math.abs(e.x - this.data.player.x) + Math.abs(e.y - this.data.player.y);
            if(dist <= 3) {
                e.hp -= 20;
                hitCount++;
                if(e.hp <= 0) this.data.enemies.splice(i, 1);
            }
        }
        if(hitCount === 0) this.log("å·ä»¤", "åŠ¹æœç¯„å›²ã«æ•µãŒã„ã¾ã›ã‚“ã§ã—ãŸã€‚");
        else this.log("å·ä»¤", `${hitCount} éƒ¨éšŠã«ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã¾ã—ãŸï¼`);
        
        this.render();
        this.updateHUD();
    }

    // æç”»å‡¦ç† (DOMæ“ä½œ)
    render() {
        this.boardEl.innerHTML = ''; // ã‚¯ãƒªã‚¢

        for (let y = 0; y < BOARD_H; y++) {
            for (let x = 0; x < BOARD_W; x++) {
                const div = document.createElement('div');
                div.className = 'cell';
                const tileType = this.data.mapData[y * BOARD_W + x];
                
                // åœ°å½¢æç”»
                if (tileType === TILE_WALL) {
                    div.classList.add('wall');
                    div.innerText = 'ğŸŒ²'; // æœ¨/å£
                } else {
                    div.classList.add('floor');
                }

                // ãƒ¦ãƒ‹ãƒƒãƒˆæç”»ï¼ˆä¸Šæ›¸ãï¼‰
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
                if (x === this.data.player.x && y === this.data.player.y) {
                    div.classList.add('player');
                    div.innerText = 'ğŸ‘‘'; // å¤§å°†
                }
                
                // æ•µ
                const enemy = this.data.enemies.find(e => e.x === x && e.y === y);
                if (enemy) {
                    div.classList.add('enemy');
                    div.innerText = 'ğŸ‘¹'; // æ•µ
                }

                this.boardEl.appendChild(div);
            }
        }
    }

    updateHUD() {
        this.hpEl.innerText = `${this.data.player.hp}/${this.data.player.maxHp}`;
        this.seedEl.innerText = this.data.seed;
    }

    log(category, message, isWarn = false) {
        const div = document.createElement('div');
        div.className = 'log-entry ' + (isWarn ? 'log-warn' : 'log-new');
        const time = new Date().toLocaleTimeString().split(' ')[0];
        div.innerText = `[${time}] ${category}: ${message}`;
        this.logEl.prepend(div);
    }

    // ==========================================
    // ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ (LocalStorageä½¿ç”¨)
    // ==========================================
    saveGame() {
        if(this.data.player.hp <= 0) {
            this.log("ã‚·ã‚¹ãƒ†ãƒ ", "æ•—åŒ—çŠ¶æ…‹ã¯ã‚»ãƒ¼ãƒ–ã§ãã¾ã›ã‚“ã€‚");
            return;
        }
        const json = JSON.stringify(this.data);
        localStorage.setItem('shogun_save_data', json);
        this.log("DB", "ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸ (Local Storage)");
    }

    loadGame() {
        const json = localStorage.getItem('shogun_save_data');
        if (!json) {
            this.log("DB", "ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }
        try {
            this.data = JSON.parse(json);
            this.log("DB", "ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ Seed:" + this.data.seed);
            this.render();
            this.updateHUD();
        } catch(e) {
            this.log("ã‚¨ãƒ©ãƒ¼", "ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã¾ã™ã€‚");
        }
    }
}

// ã‚²ãƒ¼ãƒ é–‹å§‹
const game = new GameEngine();
game.initGame();

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ã®ãƒã‚¤ãƒ³ãƒ‰
document.addEventListener('keydown', (e) => {
    switch(e.key) {
        case 'ArrowUp': case 'w': game.movePlayer(0, -1); break;
        case 'ArrowDown': case 's': game.movePlayer(0, 1); break;
        case 'ArrowLeft': case 'a': game.movePlayer(-1, 0); break;
        case 'ArrowRight': case 'd': game.movePlayer(1, 0); break;
        case 'c': game.issueCommand(); break;
    }
});

</script>
</body>
</html>